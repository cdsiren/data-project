name = "polymarket-enrichment"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

# ============================================================
# QUEUES - Optimized batch settings for 10x cost reduction
# ============================================================

[[queues.producers]]
queue = "orderbook-snapshot-queue"
binding = "SNAPSHOT_QUEUE"

[[queues.consumers]]
queue = "orderbook-snapshot-queue"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 2

# Gap backfill queue for recovery
[[queues.producers]]
queue = "gap-backfill-queue"
binding = "GAP_BACKFILL_QUEUE"

[[queues.consumers]]
queue = "gap-backfill-queue"
max_batch_size = 10
max_batch_timeout = 60
max_retries = 2

# Trade tick queue for execution-level data (backtesting)
[[queues.producers]]
queue = "trade-tick-queue"
binding = "TRADE_QUEUE"

[[queues.consumers]]
queue = "trade-tick-queue"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 2

# Level change queue for order placements/cancellations
[[queues.producers]]
queue = "level-change-queue"
binding = "LEVEL_CHANGE_QUEUE"

[[queues.consumers]]
queue = "level-change-queue"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 2

# Full L2 snapshot queue (periodic every 5 min)
[[queues.producers]]
queue = "full-l2-queue"
binding = "FULL_L2_QUEUE"

[[queues.consumers]]
queue = "full-l2-queue"
max_batch_size = 50
max_batch_timeout = 60
max_retries = 2

# ============================================================
# DURABLE OBJECTS
# ============================================================

[durable_objects]
bindings = [
  { name = "ORDERBOOK_MANAGER", class_name = "OrderbookManager" }
]

[[migrations]]
tag = "v1"
new_classes = ["OrderbookManager"]

[[migrations]]
tag = "v2"
new_classes = ["SnapshotAggregator"]

[[migrations]]
tag = "v3"
deleted_classes = ["SnapshotAggregator"]

# ============================================================
# KV NAMESPACES
# ============================================================

[[kv_namespaces]]
binding = "MARKET_CACHE"
id = "9377c262330f4d80b9fb6841d6b8cf19"

[[kv_namespaces]]
binding = "HASH_CHAIN_CACHE"
id = "2d5f178dcab04f4697eb6f6a9a0946a5"

# ============================================================
# SCHEDULED TRIGGERS
# - Market lifecycle check every 5 minutes (resolutions & new markets)
# ============================================================

[triggers]
crons = ["*/5 * * * *"]

# ============================================================
# ENVIRONMENT VARIABLES
# ============================================================

[vars]
GAMMA_API_URL = "https://gamma-api.polymarket.com"
CLOB_WSS_URL = "wss://ws-subscriptions-clob.polymarket.com/ws/market"
SNAPSHOT_INTERVAL_MS = "60000"

# Secrets (set with: wrangler secret put SECRET_NAME)
# CLICKHOUSE_URL - Full URL to ClickHouse HTTP interface
# CLICKHOUSE_USER - ClickHouse username
# CLICKHOUSE_TOKEN - ClickHouse password/API key
# WEBHOOK_API_KEY - API key for Goldsky webhook authentication
