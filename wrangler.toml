name = "polymarket-enrichment"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

# Queues
[[queues.producers]]
queue = "metadata-fetch-queue"
binding = "METADATA_QUEUE"

[[queues.producers]]
queue = "orderbook-snapshot-queue"
binding = "SNAPSHOT_QUEUE"

[[queues.consumers]]
queue = "metadata-fetch-queue"
max_batch_size = 10
max_batch_timeout = 5

[[queues.consumers]]
queue = "orderbook-snapshot-queue"
max_batch_size = 50
max_batch_timeout = 10

# Gap backfill queue for recovery
[[queues.producers]]
queue = "gap-backfill-queue"
binding = "GAP_BACKFILL_QUEUE"

[[queues.consumers]]
queue = "gap-backfill-queue"
max_batch_size = 5
max_batch_timeout = 30
max_retries = 3

# Trade tick queue for execution-level data (backtesting)
[[queues.producers]]
queue = "trade-tick-queue"
binding = "TRADE_QUEUE"

[[queues.consumers]]
queue = "trade-tick-queue"
max_batch_size = 100
max_batch_timeout = 5

# Durable Objects
[durable_objects]
bindings = [
  { name = "ORDERBOOK_MANAGER", class_name = "OrderbookManager" }
]

[[migrations]]
tag = "v1"
new_classes = ["OrderbookManager"]

# KV Namespaces
[[kv_namespaces]]
binding = "MARKET_CACHE"
id = "9377c262330f4d80b9fb6841d6b8cf19"

# Hash chain cache for gap detection (create with: wrangler kv:namespace create HASH_CHAIN_CACHE)
[[kv_namespaces]]
binding = "HASH_CHAIN_CACHE"
id = "2d5f178dcab04f4697eb6f6a9a0946a5"

# Environment variables
[vars]
GAMMA_API_URL = "https://gamma-api.polymarket.com"
CLOB_WSS_URL = "wss://ws-subscriptions-clob.polymarket.com/ws/market"
SNAPSHOT_INTERVAL_MS = "60000"

# Secrets (set with: wrangler secret put SECRET_NAME)
# CLICKHOUSE_URL - Full URL to ClickHouse HTTP interface (e.g., https://your-instance.clickhouse.cloud:8443)
# CLICKHOUSE_USER - ClickHouse username (e.g., default)
# CLICKHOUSE_TOKEN - ClickHouse password/API key
# WEBHOOK_API_KEY - API key for Goldsky webhook authentication
