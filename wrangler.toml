name = "polymarket-enrichment"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

# ============================================================
# QUEUES - Optimized batch settings with reliability improvements
# Cloudflare limits: max_batch_size=1-100, max_batch_timeout=0-60s
# ============================================================

# Dead Letter Queue for failed messages (reliability improvement)
[[queues.producers]]
queue = "dead-letter-queue"
binding = "DEAD_LETTER_QUEUE"

[[queues.consumers]]
queue = "dead-letter-queue"
max_batch_size = 100      # Max allowed by Cloudflare
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 0  # DLQ messages are stored, not retried

[[queues.producers]]
queue = "orderbook-snapshot-queue"
binding = "SNAPSHOT_QUEUE"

[[queues.consumers]]
queue = "orderbook-snapshot-queue"
max_batch_size = 100      # Max allowed by Cloudflare
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 5
dead_letter_queue = "dead-letter-queue"

# Gap backfill queue for recovery - keep small for quick recovery
[[queues.producers]]
queue = "gap-backfill-queue"
binding = "GAP_BACKFILL_QUEUE"

[[queues.consumers]]
queue = "gap-backfill-queue"
max_batch_size = 10       # Keep small for quick recovery
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 5
dead_letter_queue = "dead-letter-queue"

# Trade tick queue for execution-level data (backtesting)
[[queues.producers]]
queue = "trade-tick-queue"
binding = "TRADE_QUEUE"

[[queues.consumers]]
queue = "trade-tick-queue"
max_batch_size = 100      # Max allowed by Cloudflare
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 5
dead_letter_queue = "dead-letter-queue"

# Level change queue for order placements/cancellations
[[queues.producers]]
queue = "level-change-queue"
binding = "LEVEL_CHANGE_QUEUE"

[[queues.consumers]]
queue = "level-change-queue"
max_batch_size = 100      # Max allowed by Cloudflare
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 5
dead_letter_queue = "dead-letter-queue"

# Full L2 snapshot queue (periodic every 30 min after Phase 6)
[[queues.producers]]
queue = "full-l2-queue"
binding = "FULL_L2_QUEUE"

[[queues.consumers]]
queue = "full-l2-queue"
max_batch_size = 100      # Max allowed by Cloudflare
max_batch_timeout = 60    # Max allowed by Cloudflare
max_retries = 5
dead_letter_queue = "dead-letter-queue"

# ============================================================
# DURABLE OBJECTS
# ============================================================

[durable_objects]
bindings = [
  { name = "ORDERBOOK_MANAGER", class_name = "OrderbookManager" },
  { name = "TRIGGER_EVENT_BUFFER", class_name = "TriggerEventBuffer" }
]

[[migrations]]
tag = "v1"
new_classes = ["OrderbookManager"]

[[migrations]]
tag = "v2"
new_classes = ["SnapshotAggregator"]

[[migrations]]
tag = "v3"
deleted_classes = ["SnapshotAggregator"]

[[migrations]]
tag = "v4"
new_classes = ["TriggerEventBuffer"]

# ============================================================
# KV NAMESPACES
# ============================================================

[[kv_namespaces]]
binding = "MARKET_CACHE"
id = "9377c262330f4d80b9fb6841d6b8cf19"

[[kv_namespaces]]
binding = "HASH_CHAIN_CACHE"
id = "2d5f178dcab04f4697eb6f6a9a0946a5"

# ============================================================
# SCHEDULED TRIGGERS
# - Market lifecycle check every 5 minutes (resolutions & new markets)
# ============================================================

[triggers]
crons = ["*/5 * * * *"]

# ============================================================
# ENVIRONMENT VARIABLES
# ============================================================

[vars]
GAMMA_API_URL = "https://gamma-api.polymarket.com"
CLOB_WSS_URL = "wss://ws-subscriptions-clob.polymarket.com/ws/market"
SNAPSHOT_INTERVAL_MS = "60000"

# Multi-market configuration
# Each market defines its adapter, connection settings, and market-specific config
# To add a new market: add an entry here and implement the adapter in /src/adapters/{market}/
MARKETS_CONFIG = '''
[
  {
    "market_source": "polymarket",
    "market_type": "prediction",
    "enabled": true,
    "ws_url": "wss://ws-subscriptions-clob.polymarket.com/ws/market",
    "metadata_api_url": "https://gamma-api.polymarket.com",
    "adapter_class": "PolymarketConnector",
    "config": {
      "max_instruments_per_ws": 500,
      "price_range": [0.0, 1.0],
      "heartbeat_interval_ms": 30000,
      "reconnect_base_delay_ms": 1000,
      "reconnect_max_delay_ms": 30000
    }
  },
  {
    "market_source": "kalshi",
    "market_type": "prediction",
    "enabled": false,
    "ws_url": "wss://trading-api.kalshi.com/v1/ws",
    "metadata_api_url": "https://api.kalshi.com/v1",
    "adapter_class": "KalshiConnector",
    "config": {
      "max_instruments_per_ws": 100,
      "price_range": [0.0, 1.0],
      "heartbeat_interval_ms": 10000,
      "reconnect_base_delay_ms": 1000,
      "reconnect_max_delay_ms": 30000,
      "requires_auth": true
    }
  }
]
'''

# Secrets (set with: wrangler secret put SECRET_NAME)
# CLICKHOUSE_URL - Full URL to ClickHouse HTTP interface
# CLICKHOUSE_USER - ClickHouse username
# CLICKHOUSE_TOKEN - ClickHouse password/API key
# VITE_DASHBOARD_API_KEY - API key for dashboard and API access
